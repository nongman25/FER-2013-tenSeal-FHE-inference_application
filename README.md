# FHE Emotion Prototype (Privacy-Preserving AI)

μ΄ ν”„λ΅μ νΈλ” **λ™ν•μ•”νΈ(Homomorphic Encryption, FHE)** κΈ°μ μ„ ν™μ©ν•μ—¬, μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈμ μ›λ³Έ μ΄λ―Έμ§€λ¥Ό μ „ν€ λ³΄μ§€ λ»ν•λ” μƒνƒμ—μ„ κ°μ •μ„ λ¶„μ„ν•λ” **ν”„λΌμ΄λ²„μ‹ λ³΄μ΅΄ν• AI μ„λΉ„μ¤**μ ν”„λ΅ν† νƒ€μ…μ…λ‹λ‹¤.

## ν•µμ‹¬ μ»¨μ…‰ (Core Concept)

1.  **Zero Privacy Leakage**: μ‚¬μ©μμ μ–Όκµ΄ μ΄λ―Έμ§€λ” ν΄λΌμ΄μ–ΈνΈ(λΈλΌμ°μ €/λ΅μ»¬)μ—μ„ μ•”νΈν™”λμ–΄ μ„λ²„λ΅ μ „μ†΅λ©λ‹λ‹¤.
2.  **Encrypted Inference**: μ„λ²„λ” μ•”νΈν™”λ μƒνƒ κ·Έλ€λ΅ λ”¥λ¬λ‹(CNN) μ—°μ‚°μ„ μν–‰ν•©λ‹λ‹¤.
3.  **Owner-Only Decryption**: λ¶„μ„ κ²°κ³Ό λν• μ•”νΈν™”λμ–΄ μμΌλ©°, λΉ„λ°€ν‚¤(Secret Key)λ¥Ό κ°€μ§„ μ‚¬μ©μ λ³ΈμΈλ§ κ²°κ³Όλ¥Ό ν•΄λ…ν•μ—¬ λ³Ό μ μμµλ‹λ‹¤.

## μ‹μ¤ν… μ•„ν‚¤ν…μ² (Architecture)

μ΄ ν”„λ΅μ νΈλ” ν¬κ² \*\*Frontend (Client)\*\*μ™€ \*\*Backend (Server)\*\*λ΅ λ‚λ‰λ©°, μ² μ €ν• μ—­ν•  λ¶„λ¦¬λ¥Ό ν†µν•΄ λ³΄μ•μ„ μ μ§€ν•©λ‹λ‹¤.

### 1\. Client (Streamlit) - "The Trust Zone"

  * **μ—­ν• **: μ‚¬μ©μ μΈν„°νμ΄μ¤, **ν‚¤ μƒμ„± λ° κ΄€λ¦¬**, λ°μ΄ν„° μ•”νΈν™”/λ³µνΈν™”
  * **νΉμ§•**:
      * CKKS λ™ν•μ•”νΈ ν‚¤ μ(Public/Secret)μ„ μƒμ„±ν•©λ‹λ‹¤.
      * \*\*λΉ„λ°€ν‚¤(Secret Key)\*\*λ” μ λ€ μ„λ²„λ΅ μ „μ†΅λμ§€ μ•κ³  λ΅μ»¬μ—λ§ μ €μ¥λ©λ‹λ‹¤.
      * μ΄λ―Έμ§€λ¥Ό μ „μ²λ¦¬ν•κ³  μ•”νΈν™”ν•μ—¬ μ„λ²„μ— μ¶”λ΅ μ„ μ”μ²­ν•©λ‹λ‹¤.
      * μ„λ²„λ΅λ¶€ν„° λ°›μ€ μ•”νΈν™”λ κ²°κ³Όλ¥Ό λ³µνΈν™”ν•μ—¬ μ‹κ°ν™” λ° μ •μ‹ κ±΄κ°• μ§„λ‹¨μ„ μν–‰ν•©λ‹λ‹¤.

### 2\. Backend (FastAPI) - "The Untrusted Zone"

  * **μ—­ν• **: μΈμ¦, DB μ €μ¥, **λ™ν•μ•”νΈ μ—°μ‚°(Inference & Statistics)**
  * **νΉμ§•**:
      * ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° λ°›μ€ \*\*Evaluation Key(μ—°μ‚° μ „μ© ν‚¤)\*\*λ§ λ“±λ΅ν•©λ‹λ‹¤.
      * TenSEAL λΌμ΄λΈλ¬λ¦¬λ¥Ό μ‚¬μ©ν•΄ μ•”νΈν™”λ λ°μ΄ν„° μ„μ—μ„ CNN λ¨λΈμ„ λλ¦½λ‹λ‹¤.
      * μ•”νΈν™”λ μƒνƒμ κ°μ • λ°μ΄ν„°λ“¤μ„ ν•©μ‚°ν•κ±°λ‚ λ³€λ™μ„±μ„ κ³„μ‚°(Aggregation)ν•μ—¬ ν†µκ³„ μλ£λ¥Ό λ§λ“­λ‹λ‹¤.

-----

## π€ Dockerλ΅ μ‹¤ν–‰ν•κΈ° (κ¶μ¥)

λ³µμ΅ν• ν™κ²½ μ„¤μ • μ—†μ΄ Dockerλ§ μμΌλ©΄ μ „μ²΄ μ„λΉ„μ¤λ¥Ό ν• λ²μ— μ‹¤ν–‰ν•  μ μμµλ‹λ‹¤.

### μ‚¬μ „ μ¤€λΉ„
*   [Docker Desktop](https://www.docker.com/products/docker-desktop/) μ„¤μΉ

### μ‹¤ν–‰ λ°©λ²•
ν”„λ΅μ νΈ λ£¨νΈ λ””λ ‰ν† λ¦¬(`prototype_app/`)μ—μ„ λ‹¤μ λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•μ„Έμ”.

```bash
docker-compose up --build
```

*   **Client (Streamlit):** [http://localhost:8501](http://localhost:8501)
*   **Backend (API Docs):** [http://localhost:8000/docs](http://localhost:8000/docs)
*   **DB (MySQL):** localhost:3306 (μ»¨ν…μ΄λ„ λ‚΄λ¶€ ν†µμ‹ )

### λ°μ΄ν„° μμ†μ„± (Persistence)
*   **DB λ°μ΄ν„°:** `db_data` λ³Όλ¥¨μ— μ €μ¥λμ–΄ μ»¨ν…μ΄λ„λ¥Ό μ¬μ‹μ‘ν•΄λ„ μ μ§€λ©λ‹λ‹¤.
*   **FHE ν‚¤:** `client/streamlit_app/keys` ν΄λ”μ— μ €μ¥λ©λ‹λ‹¤. (λ΅μ»¬ νμΌ μ‹μ¤ν…κ³Ό λ§μ΄νΈλ¨)
*   **μ„λ²„ μ»¨ν…μ¤νΈ:** `backend/app/he_contexts` ν΄λ”μ— μ €μ¥λ©λ‹λ‹¤.

---

## λ΅μ»¬ κ°λ° ν™κ²½ μ„¤μ • (Manual Setup)

Dockerλ¥Ό μ‚¬μ©ν•μ§€ μ•κ³  μ§μ ‘ μ‹¤ν–‰ν•λ ¤λ©΄ μ•„λ λ‹¨κ³„λ¥Ό λ”°λ¥΄μ„Έμ”.

### 1\. Backend (`prototype_app/backend`)

API μ„λ²„μ™€ FHE μ—”μ§„μ΄ ν¬ν•¨λμ–΄ μμµλ‹λ‹¤.

```bash
backend/app/
β”β”€β”€ api/                    # REST API λΌμ°ν„° (μ—”λ“ν¬μΈνΈ μ •μ)
β”‚   β”β”€β”€ routes_auth.py      # νμ›κ°€μ…, λ΅κ·ΈμΈ (JWT)
β”‚   β”β”€β”€ routes_emotion.py   # κ°μ • λ¶„μ„ μ”μ²­ λ° νμ¤ν† λ¦¬ μ΅°ν
β”‚   β””β”€β”€ routes_he.py        # FHE Evaluation Key λ“±λ΅
β”β”€β”€ core/                   # μ„¤μ •, DB μ—°κ²°, λ³΄μ• μ ν‹Έλ¦¬ν‹°
β”β”€β”€ fhe_core/               # β… FHE ν•µμ‹¬ λ΅μ§ (TenSEAL + PyTorch)
β”‚   β”β”€β”€ fhe_cnn.py          # λ™ν•μ•”νΈ μΉν™”μ  CNN λ¨λΈ (Square Activation μ‚¬μ©)
β”‚   β”β”€β”€ fhe_inference.py    # μ•”νΈν™”λ λ°μ΄ν„°μ— λ€ν• CNN μ¶”λ΅  λ΅μ§ (im2col, conv2d)
β”‚   β””β”€β”€ tenseal_context.py  # TenSEAL μ»¨ν…μ¤νΈ μ„¤μ • (CKKS νλΌλ―Έν„° λ“±)
β”β”€β”€ inference_model/        # ν•™μµλ λ¨λΈ κ°€μ¤‘μΉ (.pt) λ° μ •κ·ν™” ν†µκ³„
β”β”€β”€ models/                 # DB μ¤ν‚¤λ§ (User, EmotionData)
β”β”€β”€ repositories/           # DB CRUD κ³„μΈµ
β”β”€β”€ schemas/                # Pydantic λ°μ΄ν„° κ²€μ¦ λ¨λΈ (DTO)
β””β”€β”€ services/               # λΉ„μ¦λ‹μ¤ λ΅μ§
    β”β”€β”€ emotion_service.py  # λ‹¨μΌ μ΄λ―Έμ§€ λ¶„μ„ μ¤μΌ€μ¤νΈλ μ΄μ…
    β”β”€β”€ analysis_service.py # NμΌκ°„μ λ°μ΄ν„° λ¶„μ„ μ„λΉ„μ¤
    β””β”€β”€ he_service.py       # β… FHE μ—”μ§„ μ–΄λ‘ν„° (μ•”νΈν™” μ—°μ‚° μ΄κ΄„)
```

### 2\. Client (`prototype_app/client`)

μ‚¬μ©μ λ‹¨λ§ μ—­ν• μ„ ν•λ” Streamlit μ• ν”λ¦¬μΌ€μ΄μ…μ…λ‹λ‹¤.

```bash
client/streamlit_app/
β”β”€β”€ app.py                  # λ©”μΈ UI μ§„μ…μ  (λ„¤λΉ„κ²μ΄μ…, ν™”λ©΄ λ λ”λ§)
β”β”€β”€ api_client.py           # λ°±μ—”λ“ API ν†µμ‹  λ¨λ“
β”β”€β”€ diagnostics.py          # β… μ •μ‹ κ±΄κ°• μ§„λ‹¨ λ΅μ§ (λ³µνΈν™”λ λ°μ΄ν„° λ¶„μ„)
β”β”€β”€ fhe_keys.py             # β… ν‚¤ κ΄€λ¦¬ λ¨λ“ (ν‚¤ μƒμ„±, λ΅μ»¬ μ €μ¥, λ¶λ¬μ¤κΈ°)
β”β”€β”€ preprocessing.py        # μ΄λ―Έμ§€ μ „μ²λ¦¬ (Grayscale, Resize, CLAHE)
β”β”€β”€ state.py                # Streamlit μ„Έμ… μƒνƒ κ΄€λ¦¬
β”β”€β”€ config.py               # ν™κ²½ λ³€μ λ° κ²½λ΅ μ„¤μ •
β””β”€β”€ keys/                   # (μλ™μƒμ„±) λ΅μ»¬ ν‚¤ μ €μ¥μ† (.gitignore κ¶μ¥)
```

-----

## μƒμ„Έ κΈ°λ¥ μ„¤λ… (Features)

### 1\. λ™ν•μ•”νΈ ν‚¤ κ΄€λ¦¬ (Key Management)

  * **Client**: `fhe_keys.py`μ—μ„ CKKS μ¤ν‚΄(Poly Modulus Degree=32768)μ„ μ‚¬μ©ν•΄ ν‚¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤. λΉ„λ°€ν‚¤κ°€ ν¬ν•¨λ μ»¨ν…μ¤νΈλ” λ΅μ»¬ `keys/` ν΄λ”μ— `.seal` νμΌλ΅ μ €μ¥λ©λ‹λ‹¤.
  * **Server**: ν΄λΌμ΄μ–ΈνΈκ°€ λ³΄λ‚Έ **Evaluation Key**(λΉ„λ°€ν‚¤ μ μ™Έ)λ¥Ό λ°›μ•„ `he_contexts/`μ— μ €μ¥ν•κ³ , μ΄λ¥Ό μ‚¬μ©ν•΄ μ—°μ‚°μ„ μν–‰ν•©λ‹λ‹¤.

### 2\. FHE κΈ°λ° κ°μ • μ¶”λ΅  (Encrypted Inference)

  * **Process**:
    1.  ν΄λΌμ΄μ–ΈνΈκ°€ μ΄λ―Έμ§€λ¥Ό μ—…λ΅λ“ν•λ©΄ 48x48 Grayscaleλ΅ λ³€ν™ λ° μ •κ·ν™”ν•©λ‹λ‹¤.
    2.  `im2col` μΈμ½”λ”© λ°©μ‹μ„ μ‚¬μ©ν•΄ μ΄λ―Έμ§€λ¥Ό λ²΅ν„°ν™”ν•κ³  μ•”νΈν™”(CKKS Vector)ν•©λ‹λ‹¤.
    3.  μ„λ²„λ” μ•”νΈλ¬Έμ„ λ°›μ•„ `FHEEmotionCNN` λ¨λΈ(λ™ν•μ•”νΈ μ—°μ‚°μ„ μ„ν•΄ ReLU λ€μ‹  **Square($x^2$) ν™μ„±ν™” ν•¨μ** μ‚¬μ©)μ„ ν†µκ³Όμ‹ν‚µλ‹λ‹¤.
    4.  κ²°κ³Όκ°’(Logits)μ€ μ—¬μ „ν μ•”νΈν™”λ μƒνƒλ΅ ν΄λΌμ΄μ–ΈνΈμ— λ°ν™λ©λ‹λ‹¤.

### 3\. μ•”νΈν™”λ ν†µκ³„ λ¶„μ„ (Encrypted Statistics)

  * **Server-Side Aggregation**: μ„λ²„λ” μ‚¬μ©μμ κ°μ • νμ¤ν† λ¦¬λ¥Ό ν‰λ¬ΈμΌλ΅ λ³µνΈν™”ν•μ§€ μ•κ³ λ„ ν†µκ³„λ¥Ό λ‚Ό μ μμµλ‹λ‹¤.
      * **ν•©κ³„(Sum)**: μ•”νΈλ¬ΈλΌλ¦¬μ λ§μ… μ—°μ‚°.
      * **λ³€λ™μ„±(Volatility)**: μΈμ ‘ν• λ‚ μ§μ κ°μ • μ°¨μ΄λ¥Ό μ κ³±ν•μ—¬ ν•©μ‚°.
  * μ΄ κΈ°λ¥μ€ `he_service.run_encrypted_statistics`μ— κµ¬ν„λμ–΄ μμµλ‹λ‹¤.

### 4\. μ •μ‹ κ±΄κ°• μκ°€ μ§„λ‹¨ (Mental Health Diagnostics)

  * ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„κ°€ κ³„μ‚°ν•΄μ¤€ 'μ•”νΈν™”λ ν†µκ³„'λ¥Ό λ°›μ•„ λ³µνΈν™”ν•©λ‹λ‹¤.
  * `diagnostics.py`μ—μ„ λ³µνΈν™”λ λ°μ΄ν„°λ¥Ό λ°”νƒ•μΌλ΅ λ‹¤μμ„ μ§„λ‹¨ν•©λ‹λ‹¤:
      * **μ°μΈμ¦ μ„ν—**: νΉμ • κΈ°κ°„ λ™μ• 'Sad' κ°μ •μ κ°•λ„κ°€ μ„κ³„μΉλ¥Ό λ„λ”μ§€ λ¶„μ„.
      * **μ–‘κ·Ήμ„± μ¥μ• (μ΅°μΈμ¦) μ„ν—**: κ°μ •μ λ³€λ™μ„±(Instability Score)μ΄ λ†’μ€μ§€ λ¶„μ„.
  * κ²°κ³Όλ” μ§κ΄€μ μΈ UI(μ•μ •/μ£Όμ/μ„ν—)λ΅ μ‚¬μ©μμ—κ² ν‘μ‹λ©λ‹λ‹¤.

-----

## κΈ°μ  μ¤νƒ (Tech Stack)

  * **Language**: Python 3.9+
  * **FHE Library**: [TenSEAL](https://github.com/OpenMined/TenSEAL) (CKKS Scheme)
  * **Deep Learning**: PyTorch (Model Definition & Weights)
  * **Backend**: FastAPI, SQLAlchemy, MySQL/MariaDB
  * **Frontend**: Streamlit
  * **Image Processing**: OpenCV, Pillow